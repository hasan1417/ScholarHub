services:
  # PostgreSQL Database with pgvector extension
  postgres:
    image: pgvector/pgvector:pg15
    environment:
      POSTGRES_DB: scholarhub
      POSTGRES_USER: scholarhub
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-pgvector.sql:/docker-entrypoint-initdb.d/init-pgvector.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U scholarhub"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis for caching and message queues
  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Collaborative editing backend (Hocuspocus)
  collab:
    build: ./collab-server
    environment:
      - PORT=3001
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - LOG_LEVEL=info
      - COLLAB_JWT_SECRET=${COLLAB_JWT_SECRET}
      - BACKEND_BASE_URL=http://backend:8000
      - COLLAB_BOOTSTRAP_SECRET=${COLLAB_BOOTSTRAP_SECRET}
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "node /app/healthcheck.mjs"]
      interval: 15s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Backend API
  backend:
    build: ./backend
    environment:
      - DEBUG=false
      - COOKIE_DOMAIN=scholarhub.space
      - LOG_LEVEL=info
      - DATABASE_URL=postgresql://scholarhub:${POSTGRES_PASSWORD}@postgres:5432/scholarhub
      - REDIS_URL=redis://redis:6379
      - SECRET_KEY=${SECRET_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_CONVERSION_MODEL=${OPENAI_CONVERSION_MODEL:-gpt-4o}
      - OPENAI_RERANK_MODEL=${OPENAI_RERANK_MODEL:-gpt-4o-mini}
      - SCIENCEDIRECT_API_KEY=${SCIENCEDIRECT_API_KEY:-}
      - SEMANTIC_SCHOLAR_API_KEY=${SEMANTIC_SCHOLAR_API_KEY:-}
      - CORE_API_KEY=${CORE_API_KEY:-}
      - UNPAYWALL_EMAIL=${UNPAYWALL_EMAIL:-}
      - NCBI_EMAIL=${NCBI_EMAIL:-}
      - ENABLE_UNIVERSITY_SSO_DETECTION=true
      - ENABLE_PDF_REDIRECT_SEARCH=true
      - ENABLE_ALTERNATIVE_ACCESS=true
      - PROJECTS_API_ENABLED=true
      - PROJECT_FIRST_NAV_ENABLED=true
      - PROJECT_REFERENCE_SUGGESTIONS_ENABLED=true
      - PROJECT_AI_ORCHESTRATION_ENABLED=true
      - PROJECT_MEETINGS_ENABLED=${PROJECT_MEETINGS_ENABLED:-true}
      - PROJECT_NOTIFICATIONS_ENABLED=true
      - SYNC_ROOM_PREFIX=sync
      - TRANSCRIBER_ENABLED=false
      # Daily.co Video
      - DAILY_API_BASE_URL=${DAILY_API_BASE_URL:-https://api.daily.co/v1}
      - DAILY_API_KEY=${DAILY_API_KEY:-}
      - DAILY_DOMAIN=${DAILY_DOMAIN:-}
      - DAILY_ROOM_TTL_SECONDS=${DAILY_ROOM_TTL_SECONDS:-21600}
      - DAILY_TOKEN_TTL_SECONDS=${DAILY_TOKEN_TTL_SECONDS:-3600}
      - DAILY_WEBHOOK_SECRET=${DAILY_WEBHOOK_SECRET:-}
      - DAILY_WEBHOOK_URL=${DAILY_WEBHOOK_URL:-}
      - DAILY_ENABLE_RECORDING=${DAILY_ENABLE_RECORDING:-cloud}
      - DAILY_START_CLOUD_RECORDING=${DAILY_START_CLOUD_RECORDING:-true}
      - DAILY_RECORDING_AUDIO_ONLY=${DAILY_RECORDING_AUDIO_ONLY:-true}
      - ONLYOFFICE_DOCSERVER_URL=
      - ONLYOFFICE_JWT_SECRET=
      - BACKEND_PUBLIC_URL=${BACKEND_PUBLIC_URL}
      - BACKEND_CORS_ORIGINS=${BACKEND_CORS_ORIGINS}
      - PROJECT_COLLAB_REALTIME_ENABLED=true
      - COLLAB_JWT_SECRET=${COLLAB_JWT_SECRET}
      - COLLAB_BOOTSTRAP_SECRET=${COLLAB_BOOTSTRAP_SECRET}
      - COLLAB_WS_URL=wss://scholarhub.space/collab/
      - COLLAB_JWT_EXPIRE_SECONDS=300
      - LATEX_WARMUP_ON_STARTUP=true
      # Google OAuth
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI}
      # Resend Email
      - RESEND_API_KEY=${RESEND_API_KEY}
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL}
      # Frontend URL
      - FRONTEND_URL=${FRONTEND_URL}
      # OpenRouter
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - OPENROUTER_KEY_ENCRYPTION_KEY=${OPENROUTER_KEY_ENCRYPTION_KEY}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./uploads:/app/uploads
    restart: unless-stopped

  # Frontend (Production Build)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_COLLAB_ENABLED=true
        - VITE_COLLAB_WS=wss://scholarhub.space/collab/
    depends_on:
      - backend
    restart: unless-stopped

  # Nginx Reverse Proxy with SSL
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      - frontend
      - backend
      - collab
    restart: unless-stopped

  # Certbot for SSL certificates
  certbot:
    image: certbot/certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
  postgres_data:
  redis_data:
